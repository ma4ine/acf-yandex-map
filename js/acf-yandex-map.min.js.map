{"version":3,"sources":["acf-yandex-map.js"],"names":["$","acf_yandex_locale","blog_url","templateURL","template_url","postID","post_id","term_slug","post_type","term_id","mark_style_house_green","iconLayout","iconImageHref","iconImageSize","iconImageOffset","mark_style_house_orange","polygon_style_green","fillColor","strokeColor","strokeWidth","opacity","polygon_style_orange","initialize_field","$el","$element","$input","$params","$collection","$map_active","$map","$project","find","undefined","console","error","map_init_fail","parseJSON","val","log","data","when","get","response","features","length","each","index","id","content","type","geometry","coords","coordinates","done","ymaps","ready","map_init","fail","empty","destroy","Map","zoom","center","center_lat","center_lng","minZoom","controls","remove","behaviors","disable","copyrights","add","events","e","create_mark","save_map","zoom_control","control","ZoomControl","event","top","left","clear_button","Button","btn_clear_all","title","btn_clear_all_hint","options","selectOnClick","geoObjects","mark","removeAttr","right","GeoObjectCollection","preset","place_mark","marker_type","toLowerCase","mark_id","edit_url","window","location","origin","place_mark_content","balloonContentBody","hintContent","Placemark","Polygon","import_mark","marks","draggable","editorDrawingCursor","editorMaxPoints","editor","startDrawing","Monitor","state","newValue","attr","getZoom","getCenter","getType","split","_type","push","getCoordinates","JSON","stringify","acf","add_action","get_fields","this","document","on","postbox","jQuery"],"mappings":"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","file":"acf-yandex-map.min.js","sourcesContent":["(function ($) {\n\n    'use strict';\n\n    /**\n     * Get ACF data\n     */\n    var blogURL = acf_yandex_locale.blog_url;\n    var templateURL = acf_yandex_locale.template_url;\n    var postID = acf_yandex_locale.post_id;\n    var postType = acf_yandex_locale.post_type;\n    var termID = acf_yandex_locale.term_id;\n    var term_slug = acf_yandex_locale.term_slug;\n\n    var mark_style_house_green = {\n        iconLayout: 'default#image',\n        iconImageHref: templateURL + '/svg/map/mark-house-2.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-6, -18]\n    };\n\n    var mark_style_house_orange = {\n        iconLayout: 'default#image',\n        iconImageHref: templateURL + '/svg/map/mark-house-1.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-6, -18]\n    };\n\n    var polygon_style_green = {\n        fillColor: '#44A147',\n        strokeColor: '#18803F',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n\n    var polygon_style_orange = {\n        fillColor: 'rgba(0,0,0,0.00)',\n        strokeColor: '#EC6B23',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n\n    /**\n     * Initialize admin interface\n     *\n     * @param {element} $el\n     * @returns {boolean}\n     */\n    function initialize_field($el) {\n\n        /**\n         * Element for map init\n         * @type {element}\n         */\n        var $element;\n\n        /**\n         * Hidden data input\n         * @type {element}\n         */\n        var $input;\n\n        /**\n         * Saved data or default\n         *\n         * @param {float} $params.center_lat\n         * @param {float} $params.center_lng\n         * @param {string} $params.type\n         * @param {int} $params.zoom\n         * @param {Object[]} $params.marks\n         *\n         * @type {object}\n         */\n        var $params;\n\n        /**\n         * Yandex map object\n         *\n         * @type {Object}\n         */\n        var $map = null;\n\n        /**\n         * Project objects\n         *\n         * @type {array}\n         */\n        var $project = [];\n\n        /**\n         * Project collection\n         *\n         * @type {object}\n         */\n        var $collection;\n\n        /**\n         * Project collection\n         *\n         * @type {boolean}\n         */\n        var $map_active;\n\n        /// Init fields\n\n        $element = $($el).find('.map');\n        $input = ($el).find('.map-input');\n\n        if ($element == undefined || $input == undefined) {\n            console.error(acf_yandex_locale.map_init_fail);\n            return false;\n        }\n\n        /// Init params\n\n        $params = $.parseJSON($($input).val());\n\n        /// Import data & map init\n\n        if ( term_slug != 'no-project' && term_slug != undefined ) {\n\n            console.log('Import start');\n\n            var data = templateURL + '/map/data-land-' + term_slug + '.json';\n\n            $.when(\n\n                $.get(data, function(response) {\n\n                    if ( response.features.length > 0 ) {\n\n                        $.each(response.features, function(index, val) {\n                            $project[index] = {\n                                \"id\": val.id,\n                                \"content\": val.id,\n                                \"type\": val.geometry.type,\n                                // \"term\": val.term,\n                                \"coords\": val.geometry.coordinates\n                            };\n                        });\n\n                    } else {\n\n                        console.error('Data import error!');\n\n                    }\n\n                })\n\n            ).done(function() {\n\n                console.log('Import success & map start');\n\n                ymaps.ready(function () {\n                    // let's go\n                    map_init();\n                });\n\n            }).fail(function() {\n\n                console.error('Data import error!');\n\n            });\n\n        } else {\n\n            console.log('Just map start');\n\n            ymaps.ready(function () {\n                // let's go\n                map_init();\n            });\n\n        };\n\n        /**\n         * Initialization Map\n         */\n        function map_init() {\n\n            $element.empty();\n\n            if ($map != null) {\n                $map.destroy();\n                $map = null;\n                $input.val('');\n            }\n\n            $map = new ymaps.Map($element[0], {\n                zoom: $params.zoom,\n                center: [$params.center_lat, $params.center_lng],\n                type: 'yandex#' + $params.type\n            }, {\n                minZoom: 10\n            });\n\n            $map.controls.remove('trafficControl');\n            $map.controls.remove('fullscreenControl');\n            $map.controls.remove('searchControl');\n            $map.behaviors.disable('scrollZoom');\n            $map.copyrights.add('&copy; DKI ');\n\n            $map.events.add('click', function (e) {\n                if ($map_active) {\n                    create_mark(e.get('coords'));\n                    save_map();\n                }\n            });\n\n            $map.events.add('typechange', function (e) {\n                save_map();\n            });\n\n            $map.events.add('boundschange', function () {\n                save_map();\n            });\n\n            /// Geo location button\n\n            var geo_control = $map.controls.get('geolocationControl');\n            geo_control.events.add('locationchange', function () {\n                save_map();\n            });\n\n            /// Zoom Control\n\n            var zoom_control = new ymaps.control.ZoomControl();\n            zoom_control.events.add('zoomchange', function (event) {\n                save_map();\n            });\n\n            $map.controls.add(zoom_control, {top: 75, left: 5});\n\n            /// Clear all button\n\n            var clear_button = new ymaps.control.Button({\n                data: {\n                    content: acf_yandex_locale.btn_clear_all,\n                    title: acf_yandex_locale.btn_clear_all_hint\n                },\n                options: {\n                    selectOnClick: false\n                }\n            });\n\n            clear_button.events.add('click', function () {\n                $map.geoObjects.each(function (mark) {\n                    if (mark.geometry != null) { // if not collection\n                        $map.geoObjects.remove(mark);\n                    };\n                });\n                $map_active = true;\n                $('.marker-type').removeAttr('disabled');\n                save_map();\n            });\n\n            $map.controls.add(clear_button, {top: 5, right: 5});\n\n            /// Collection\n\n            $collection = new ymaps.GeoObjectCollection(null, {\n                preset: 'islands#yellowIcon'\n            });\n\n            /// Marks import\n\n            $($project).each(function(index, mark) {\n                if (mark.id != postID) { // if not this post\n                    import_mark(mark.coords, mark.type, mark.id);\n                }\n            });\n\n            /// Import load\n\n            $map.geoObjects.add($collection);\n\n            /// Marks load\n\n            $($params.marks).each(function (index, mark) {\n                create_mark(mark.coords, mark.type, mark.id, mark.content);\n            });\n\n        }\n\n        /**\n         * Import geo mark\n         *\n         * @param {Array} coords\n         * @param {string} type Point type, Point or Circle\n         * @param {int} term\n         * @param {int} id\n         * @param {string} content\n         */\n        function import_mark(coords, type, id) {\n\n            // console.log(type);\n\n            var place_mark = null;\n            var marker_type = type.toLowerCase();\n            var mark_id = id;\n            var edit_url = window.location.origin + '/wp-admin/post.php?post=' + mark_id + '&action=edit';\n\n            var place_mark_content = {\n                balloonContentBody: '<span>Объект №' + mark_id + '</span><br><a href=\"' + edit_url + '\">Редактировать</a>',\n                hintContent: mark_id\n            }\n\n            if (marker_type == 'point') { // create placemark\n\n                place_mark = new ymaps.Placemark(\n                    coords,\n                    place_mark_content,\n                    mark_style_house_orange\n                );\n\n            } else if (marker_type == 'polygon') {\n\n                place_mark = new ymaps.Polygon(\n                    [coords],\n                    place_mark_content,\n                    polygon_style_orange\n                );\n\n            } else {\n\n                console.error('Mark import error!')\n                return false;\n\n            }\n\n            $collection.add(place_mark);\n        }\n\n        /**\n         * Create geo mark\n         *\n         * @param {Array} coords\n         * @param {string} type Point type, Point or Circle\n         * @param {int} size Circle size in meters\n         * @param {int} id\n         * @param {string} content\n         */\n        function create_mark(coords, type, id, content) {\n\n            var place_mark = null;\n            var marker_type = (type != null) ? type.toLowerCase() : $($el).find('.marker-type').val();\n\n            console.log(marker_type);\n\n            var mark_id = id;\n            if (id == undefined && $params.marks.length == 0)\n                mark_id = 1;\n            else\n                mark_id = (id == undefined) ? ($params.marks[$params.marks.length - 1].id + 1) : id;\n\n            var mark_content = (content == undefined) ? '' : content;\n\n            if (marker_type == 'point') { // create placemark\n\n                mark_style_house_green.draggable = true;\n\n                place_mark = new ymaps.Placemark(\n                    coords,\n                    {},\n                    mark_style_house_green\n                );\n\n                $map.geoObjects.add(place_mark);\n\n                $map_active = false;\n\n            } else if (marker_type == 'polygon') { // if mark is polygon\n\n                if (coords.length === 2) {\n                    coords = [];\n                };\n\n                polygon_style_green.editorDrawingCursor = 'crosshair';\n                polygon_style_green.editorMaxPoints = 5;\n\n                var place_mark = new ymaps.Polygon(\n                    coords, \n                    {}, \n                    polygon_style_green \n                );\n\n                $map.geoObjects.add(place_mark);\n\n                place_mark.editor.startDrawing();\n\n                var stateMonitor = new ymaps.Monitor(place_mark.editor.state);\n                stateMonitor.add(\"drawing\", function (newValue) {\n                    $map_active = false;\n                });\n\n            } else {\n\n                console.error('Marker type error!');\n                return false;\n\n            }\n\n            place_mark.events.add('dragend', function () {\n                save_map();\n            });\n            place_mark.events.add('editorstatechange', function () {\n                save_map();\n            });\n            place_mark.events.add('geometrychange', function () {\n                save_map();\n            });\n\n            $('.marker-type').val(marker_type).attr('disabled', 'true');\n        }\n\n        /**\n         * Write map data in hidden field\n         */\n        function save_map() {\n\n            $params.zoom = $map.getZoom();\n\n            var coords = $map.getCenter();\n            $params.center_lat = coords[0];\n            $params.center_lng = coords[1];\n\n            var type = $map.getType().split('#');\n            $params.type = (type[1]) ? type[1] : 'map';\n\n            var marks = [];\n            $map.geoObjects.each(function (mark) {\n                if (mark.geometry != null) { // if not collection\n                    var _type = mark.geometry.getType();\n                    marks.push({\n                        id: postID,\n                        content: postID,\n                        type: _type,\n                        coords: mark.geometry.getCoordinates()\n                    });\n                };\n            });\n\n            $params.marks = marks;\n\n            $($input).val(JSON.stringify($params));\n        }\n\n        /**\n         * Change marker type state\n         */\n        // $('.marker-type').on('change', function () {\n        //     var label = $(this).parent().next('th').children(0);\n        //     var select = $(this).parent().next('th').next('td').children(0);\n        //     if (this.value == 'circle') {\n        //         label.removeClass('hidden');\n        //         select.removeClass('hidden');\n        //     } else {\n        //         label.addClass('hidden');\n        //         select.addClass('hidden');\n        //     }\n        // });\n\n\n    }\n\n\n    if (typeof acf.add_action !== 'undefined') {\n\n        /*\n         *  ready append (ACF5)\n         *\n         *  These are 2 events which are fired during the page load\n         *  ready = on page load similar to $(document).ready()\n         *  append = on new DOM elements appended via repeater field\n         *\n         *  @type\tevent\n         *  @date\t20/07/13\n         *\n         *  @param\t$el (jQuery selection) the jQuery element which contains the ACF fields\n         *  @return\tn/a\n         */\n\n        acf.add_action('ready append', function ($el) {\n\n            // search $el for fields of type 'FIELD_NAME'\n            acf.get_fields({type: 'yandex-map'}, $el).each(function () {\n\n                initialize_field($(this));\n\n            });\n\n        });\n\n\n    } else {\n\n\n        /*\n         *  acf/setup_fields (ACF4)\n         *\n         *  This event is triggered when ACF adds any new elements to the DOM.\n         *\n         *  @type\tfunction\n         *  @since\t1.0.0\n         *  @date\t01/01/12\n         *\n         *  @param\tevent\t\te: an event object. This can be ignored\n         *  @param\tElement\t\tpostbox: An element which contains the new HTML\n         *\n         *  @return\tn/a\n         */\n\n        $(document).on('acf/setup_fields', function (e, postbox) {\n\n            $(postbox).find('.field[data-field_type=\"yandex-map\"]').each(function () {\n\n                initialize_field($(this));\n\n            });\n\n        });\n\n\n    }\n\n\n})(jQuery);"]}