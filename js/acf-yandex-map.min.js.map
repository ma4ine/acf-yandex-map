{"version":3,"sources":["acf-yandex-map.js"],"names":["$","$location","val","text","initialize_field","$el","$element","$input","$params","$map","find","undefined","console","error","acf_yandex_locale","map_init_fail","map_init","empty","destroy","ymaps","Map","zoom","center","center_lat","center_lng","type","minZoom","controls","remove","behaviors","disable","copyrights","add","events","e","create_mark","get","save_map","marks","length","geocode","then","res","object","geoObjects","coords","geometry","getCoordinates","bounds","properties","setBounds","checkZoomRange","err","log","search_controll","options","set","noPlacemark","useMapBounds","noSelect","kind","width","zoom_control","control","ZoomControl","event","top","left","clear_button","Button","data","content","btn_clear_all","title","btn_clear_all_hint","selectOnClick","balloon","close","removeAll","right","each","index","mark","circle_size","id","getCenter","setCenter","getZoom","duration","submit","name","imported","parseJSON","value","alert","import_map","this","serializeArray","focus","select","import_button","image","btn_import","open","getBounds","import_desc","import_go","export_button","btn_export","export_desc","JSON","stringify","click","mark_id","currentTarget","parent","children","form","map","n","i","size","place_mark","marker_type","toLowerCase","mark_content","Placemark","hintContent","mark_hint","preset","draggable","parseInt","Circle","opacity","fillOpacity","fillColor","strokeColor","strokeOpacity","strokeWidth","Polygon","editorDrawingCursor","editorMaxPoints","Monitor","editor","state","newValue","startDrawing","getType","split","_type","push","getRadius","ready","on","label","next","removeClass","addClass","acf","add_action","get_fields","document","postbox","jQuery"],"mappings":"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","file":"acf-yandex-map.min.js","sourcesContent":["(function ($) {\n\n    // 'use strict';\n\n    /**\n     * Get ACF data\n     */\n    var $district = $('[data-name=\"location-district\"] input').val();\n    var $city = $('[data-name=\"location-city\"] select option[selected=\"selected\"]').text();\n    var $address = $('[data-name=\"location-address\"] input').val();\n    var $location = $district + ', ' + $city + ', ' + $address;\n\n    /**\n     * Initialize admin interface\n     *\n     * @param {element} $el\n     * @returns {boolean}\n     */\n    function initialize_field($el) {\n\n        /**\n         * Element for map init\n         * @type {element}\n         */\n        var $element;\n\n        /**\n         * Hidden data input\n         * @type {element}\n         */\n        var $input;\n\n        /**\n         * Saved data or default\n         *\n         * @param {float} $params.center_lat\n         * @param {float} $params.center_lng\n         * @param {string} $params.type\n         * @param {int} $params.zoom\n         * @param {Object[]} $params.marks\n         *\n         * @type {object}\n         */\n        var $params;\n\n        /**\n         * Yandex map object\n         *\n         * @type {Object}\n         */\n        var $map = null;\n\n        /**\n         * Yandex map geocoder\n         *\n         */\n        var $geocoder;\n\n        /**\n         * Geocoder coordinates\n         *\n         */\n        var $coords;\n\n        /// Init fields\n\n        $element = $($el).find('.map');\n        $input = ($el).find('.map-input');\n\n        if ($element == undefined || $input == undefined) {\n            console.error(acf_yandex_locale.map_init_fail);\n            return false;\n        }\n\n        /// Init params\n\n        $params = $.parseJSON($($input).val());\n\n        /// Init map\n\n        ymaps.ready(function () {\n            map_init();\n        });\n\n        /**\n         * Initialization Map\n         */\n        function map_init() {\n\n            $element.empty();\n\n            if ($map != null) {\n                $map.destroy();\n                $map = null;\n                $input.val('');\n            }\n\n            $map = new ymaps.Map($element[0], {\n                zoom: $params.zoom,\n                center: [$params.center_lat, $params.center_lng],\n                type: 'yandex#' + $params.type\n            }, {\n                minZoom: 10\n            });\n\n            $map.controls.remove('trafficControl');\n            $map.controls.remove('fullscreenControl');\n            $map.behaviors.disable('scrollZoom');\n            $map.copyrights.add('&copy; Const Lab. ');\n\n            $map.events.add('click', function (e) {\n                create_mark(e.get('coords'));\n                save_map();\n            });\n\n            $map.events.add('typechange', function (e) {\n                save_map();\n            });\n\n            $map.events.add('boundschange', function () {\n                save_map();\n            });\n\n            /// Project Lands Import (temporary disabled)\n\n            // var blogURL = acf_yandex_locale.blog_url;\n            // var postType = acf_yandex_locale.post_type;\n            // var termID = acf_yandex_locale.term_id;\n\n            // console.log(acf_yandex_locale.current_screen);\n\n            // if post type is 'land'\n            // if ( postType === 'land' ) {\n            //     // get lands\n            //     getLands();\n\n            //     function getLands() {\n\n            //         $.ajax({\n            //             type: 'GET',\n            //             dataType: 'json',\n            //             url: blogURL + '/wp-json/wp/v2/land?project=' + termID,\n            //             success: function(response) {\n\n            //                 // console.log(response[0]);\n\n            //                 var data = {\n            //                     type: 'FeatureCollection',\n            //                     features: []\n            //                 };\n\n            //                 $.each(response, function(index, post) {\n\n            //                     // Обработаем некоторые данные заранее\n            //                     var address = post.acf['location-district'] + ', ' + post.acf['location-city']['name'] + ', ' + post.acf['location-address'];\n\n            //                     // var square = post.acf[ 'land-square' ] + ' сот.';\n\n            //                     // if ( post.acf['landscape-pic'].length > 0 ) {\n            //                     //     var slope = '<img src=\"' + templateURL + '/svg/landscape/' + post.acf['landscape-pic'] +'.svg\" alt=\"Ландшафт\" class=\"slope--img slope--img-hor\">';\n            //                     // } else {\n            //                     //     var slope = '';\n            //                     // }\n\n            //                     // if ( post.acf.status != undefined ) {\n            //                     //     var status = post.acf.status.name;\n            //                     // };\n\n            //                     // Проверим наличие плагина, распарсим данные\n            //                     if ( post.acf.ymap != undefined ) {\n            //                         var json = $.parseJSON(post.acf.ymap);\n            //                     };\n\n            //                     if ( post.acf.ymap != undefined && json.marks.length > 0 ) { // Если установлены координаты в плагине\n            //                         // Получим координаты из плагина\n            //                         var coords = json.marks[0].coords;\n            //                         // Определим геометрию объекта\n            //                         var geometryType = coords.length === 1 ? 'Polygon' : 'Point';\n\n            //                     } else {\n\n            //                         // Если нет, получим координаты из Геокодера\n            //                         var defaultCoords;\n\n            //                         $.get({\n            //                             async: false,\n            //                             url: 'https://geocode-maps.yandex.ru/1.x/?format=json&geocode=' + address.replace( ', ', '+' ),\n            //                             success: function(data) {\n            //                                 defaultCoords = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos;\n            //                             }\n            //                         }); \n\n            //                         var coords = defaultCoords.split(' ').reverse();\n            //                         var geometryType = 'Point';\n\n            //                     }; // Координаты определены\n\n            //                     var dataItem = {\n            //                         type: 'Feature',\n            //                         // postType: post.type, \n            //                         id: post.id,\n            //                         // link: post.link,\n            //                         options: {\n            //                             fillColor: '#44A147',\n            //                             strokeColor: '#18803F',\n            //                             strokeWidth: 2,\n            //                             opacity: 0.25\n            //                         },\n            //                         geometry: {\n            //                             type: geometryType,\n            //                             coordinates: coords\n            //                         },\n            //                         properties: {\n            //                             hintContent: post.title.rendered\n            //                         }\n            //                     };\n\n            //                     data['features'].push( dataItem );\n                                 \n            //                 }); // each end\n\n            //                 postData( data );\n\n            //             }, // success end\n            //             error: function(data) {\n            //                 // `data` will not be JSON\n            //                 console.log('JSON Error');\n            //             }\n\n            //         });\n\n            //     };\n\n            //     // post lands to json\n            //     function postData( data ) {\n\n            //         $.post({\n            //             url : blogURL + '/wp-content/plugins/acf-yandex-map/ajax/ajax-map.php',\n            //             data : {\n            //                 // postType: postType,\n            //                 json : JSON.stringify(data, \"\", 2)\n            //             },\n            //             success: function(response) {\n            //                 console.log('AJAX POST PROJECT');\n            //                 // let's load data to map\n            //                 loadData();\n            //             }\n            //         })  \n\n            //     };\n\n            //     // load data to map\n            //     function loadData() {\n            //         $.get({\n            //             url: blogURL + '/wp-content/plugins/acf-yandex-map/ajax/data-project.json'\n            //         }).done(function(data) {\n            //             // create object manager\n            //             var objectManager = new ymaps.ObjectManager();\n            //             // set-up object manager\n            //             objectManager.objects.options.set({\n            //                 preset: 'islands#darkOrangeDotIcon'\n            //             });\n            //             // add data\n            //             objectManager.add(data);\n            //             // add object manager to map\n            //             $map.geoObjects.add(objectManager);\n            //             // set bounds\n            //             // $map.setBounds(objectManager.getBounds());\n            //         });\n            //     };\n\n                \n            // };\n\n            /// Geocoder\n\n            if ( $params.marks.length === 0 ) { // if there are no marks\n                \n                // console.log('Geocoder works here');\n\n                $geocoder = ymaps.geocode( $location ); // start geocoder\n\n                $geocoder.then(function (res) {\n\n                    var object = res.geoObjects.get(0); // get first object\n                    var coords = object.geometry.getCoordinates(); // get coords\n                    var bounds = object.properties.get('boundedBy'); // get bounds\n\n                    create_mark(coords, 'Point', 0, 1, ''); // create mark\n\n                    $map.setBounds(bounds, { checkZoomRange: true }); // show map with bounds\n\n                    save_map(); // save map\n\n                }, function (err) {\n                    console.log('Yandex.Maps Geocoder Error');\n                });\n\n            };\n\n            /// Search Control\n\n            var search_controll = $map.controls.get('searchControl');\n            search_controll.options.set({\n                noPlacemark: true,\n                useMapBounds: true, // was false\n                noSelect: true,\n                kind: 'locality',\n                width: 250\n            });\n\n            search_controll.events.add('resultselect', function () {\n                // $map.geoObjects.removeAll(); // remove all placemarks\n                // create_mark(e.get('coords')); // create mark\n                save_map();\n            });\n\n            /// Geo location button\n\n            var geo_control = $map.controls.get('geolocationControl');\n            geo_control.events.add('locationchange', function () {\n                // $map.geoObjects.removeAll(); // don't remove placemark\n                save_map();\n            });\n\n            /// Zoom Control\n\n            var zoom_control = new ymaps.control.ZoomControl();\n            zoom_control.events.add('zoomchange', function (event) {\n                save_map();\n            });\n\n            $map.controls.add(zoom_control, {top: 75, left: 5});\n\n            /// Clear all button\n\n            var clear_button = new ymaps.control.Button({\n                data: {\n                    content: acf_yandex_locale.btn_clear_all,\n                    title: acf_yandex_locale.btn_clear_all_hint\n                },\n                options: {\n                    selectOnClick: false\n                }\n            });\n\n            clear_button.events.add('click', function () {\n                $map.balloon.close();\n                $map.geoObjects.removeAll();\n                save_map();\n            });\n\n            $map.controls.add(clear_button, {top: 5, right: 5});\n\n            /// Marks load\n\n            $($params.marks).each(function (index, mark) {\n                create_mark(mark.coords, mark.type, mark.circle_size, mark.id, mark.content);\n            });\n\n            /// Map balloon\n\n            var center = $map.getCenter();\n\n            $map.balloon.events.add('autopanbegin', function () {\n                center = $map.getCenter();\n            });\n\n            $map.balloon.events.add('close', function () {\n                $map.setCenter(center, $map.getZoom(), {\n                    duration: 500\n                });\n            });\n\n            $map.balloon.events.add('open', function () {\n                $($el).find('.ya-import form').submit(function () {\n                    import_map($(this).serializeArray());\n                    return false;\n                });\n                $($el).find('.ya-import textarea, .ya-export textarea').focus().select();\n            });\n\n            /// Import Export Controls\n\n            var import_button = new ymaps.control.Button({\n                data: {\n                    image: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIxNnB4IiBoZWlnaHQ9IjE2cHgiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTYgMTYiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxnPjxwYXRoIGZpbGw9IiM2NjY2NjYiIGQ9Ik0xMi42LDRoLTEuMDIxYy0wLjI3NiwwLTAuNSwwLjIyNC0wLjUsMC41czAuMjI0LDAuNSwwLjUsMC41SDEyLjZDMTMuMzk4LDUsMTQsNS42NDUsMTQsNi41djZjMCwwLjg1NS0wLjYwMiwxLjUtMS40LDEuNWgtMTBDMS43NDgsMTQsMSwxMy4yOTksMSwxMi41di02QzEsNS43MDEsMS43NDgsNSwyLjYsNWgwLjc2OGMwLjI3NiwwLDAuNS0wLjIyNCwwLjUtMC41UzMuNjQ1LDQsMy4zNjgsNEgyLjZDMS4xOTEsNCwwLDUuMTQ1LDAsNi41djZDMCwxMy44NTUsMS4xOTEsMTUsMi42LDE1aDEwYzEuMzQ2LDAsMi40LTEuMDk4LDIuNC0yLjV2LTZDMTUsNS4wOTgsMTMuOTQ1LDQsMTIuNiw0eiIvPjxwYXRoIGZpbGw9IiM2NjY2NjYiIGQ9Ik03LjEzMywxMC4wMzRjMC4xMzcsMC4zMTUsMC41NjgsMC40MTMsMC43MDMsMC4xMDFjMC4wMTItMC4wMjksMS4xNzctMi40MTksMS45MjktMy4zNzNjMC4yNjQtMC4zMzUtMC4wOTUtMC42NC0wLjQ2My0wLjUzQzguOTgsNi4zMjgsNy45NjYsNy4wNTIsNy45NjYsNy4xMDFWMC41NzZjMC0wLjI3Ni0wLjE4OC0wLjU5MS0wLjQ2NS0wLjU5MWMtMC4wMDIsMC0wLjAwMywwLjAwMS0wLjAwNSwwLjAwMXMwLjAwMS0wLjAwMS0wLjAwMS0wLjAwMWMtMC4yNzYsMC0wLjQ5NSwwLjIyNC0wLjQ5NSwwLjVWNy4wMWMwLTAuMDQ5LTEuMDE4LTAuNzc0LTEuMzM5LTAuODY5Yy0wLjM2OC0wLjExLTAuNzE4LDAuMTg3LTAuNDY2LDAuNTNDNS44Nyw3LjU4Nyw2LjY1OSw4Ljk0Myw3LjEzMywxMC4wMzR6Ii8+PC9nPjwvc3ZnPg==',\n                    title: acf_yandex_locale.btn_import\n                },\n                options: {\n                    selectOnClick: false\n                }\n            });\n\n            import_button.events.add('click', function () {\n                $map.balloon.close();\n                $map.balloon.open($map.getBounds()[0], '<div class=\"ya-import\" style=\"margin: 5px\"><p class=\"description\">' + acf_yandex_locale.import_desc + '</p><form><textarea name=\"import\" cols=\"40\" rows=\"5\" autofocus></textarea><br><input type=\"submit\" class=\"button\" name=\"submit\" value=\"' + acf_yandex_locale.import_go + '\"/></form></div>');\n\n            });\n\n            var export_button = new ymaps.control.Button({\n                data: {\n                    image: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIxNnB4IiBoZWlnaHQ9IjE2cHgiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTYgMTYiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxnPjxwYXRoIGZpbGw9IiM2NjY2NjYiIGQ9Ik0xMi42LDRoLTEuMDIxYy0wLjI3NiwwLTAuNSwwLjIyNC0wLjUsMC41czAuMjI0LDAuNSwwLjUsMC41SDEyLjZDMTMuMzk4LDUsMTQsNS42NDUsMTQsNi41djZjMCwwLjg1NS0wLjYwMiwxLjUtMS40LDEuNWgtMTBDMS43NDgsMTQsMSwxMy4yOTksMSwxMi41di02QzEsNS43MDEsMS43NDgsNSwyLjYsNWgwLjc2OGMwLjI3NiwwLDAuNS0wLjIyNCwwLjUtMC41UzMuNjQ1LDQsMy4zNjgsNEgyLjZDMS4xOTEsNCwwLDUuMTQ1LDAsNi41djZDMCwxMy44NTUsMS4xOTEsMTUsMi42LDE1aDEwYzEuMzQ2LDAsMi40LTEuMDk4LDIuNC0yLjV2LTZDMTUsNS4wOTgsMTMuOTQ1LDQsMTIuNiw0eiIvPjxwYXRoIGZpbGw9IiM2NjY2NjYiIGQ9Ik03Ljg2OCwwLjIyNWMtMC4xMzctMC4zMTUtMC42MDItMC4zMjItMC43MzctMC4wMUM3LjExOCwwLjI0NCw1Ljk1NCwyLjYzNCw1LjIwMiwzLjU4OGMtMC4yNjQsMC4zMzUsMC4wOTUsMC42NCwwLjQ2MywwLjUzQzUuOTg2LDQuMDIyLDcsMy4yOTgsNywzLjI0OXY2LjUyNmMwLDAuMjc2LDAuMjIzLDAuNSwwLjQ5OSwwLjVjMC4wMDIsMCwwLjAwMy0wLjAwMSwwLjAwNS0wLjAwMXMtMC4wMDEsMC4wMDEsMC4wMDEsMC4wMDFjMC4yNzYsMCwwLjQ5NS0wLjIyNCwwLjQ5NS0wLjVWMy4yNDljMCwwLjA0OSwxLjAxOCwwLjc3NCwxLjMzOSwwLjg2OWMwLjM2OCwwLjExLDAuNzE4LTAuMTg3LDAuNDY2LTAuNTNDOS4xMzEsMi42NzEsOC4zNDEsMS4zMTUsNy44NjgsMC4yMjV6Ii8+PC9nPjwvc3ZnPg==',\n                    title: acf_yandex_locale.btn_export\n                },\n                options: {\n                    selectOnClick: false\n                }\n            });\n\n            export_button.events.add('click', function () {\n                $map.balloon.close();\n\n                $map.balloon.open($map.getBounds()[0], '<div class=\"ya-export\" style=\"margin: 5px\"><p class=\"description\">' + acf_yandex_locale.export_desc + '</p><textarea cols=\"40\" rows=\"5\" readonly>'\n                + JSON.stringify($params) + '</textarea></div>');\n            });\n\n            /// Mark editor\n\n            $map.events.add('balloonopen', function () {\n                $('.ya-editor textarea').focus();\n\n                $('.ya-editor .remove').click(function (event) {\n                    var mark_id = $(event.currentTarget).parent('form').children('input[type=\"hidden\"]').val();\n                    if (mark_id == undefined) return false;\n\n                    $map.balloon.close();\n                    $map.geoObjects.each(function (mark) {\n                        if (mark.properties.get('id') == mark_id)\n                            $map.geoObjects.remove(mark);\n                    });\n\n                    return false;\n                });\n\n                $('.ya-editor form').submit(function () {\n                    var data = $(this).serializeArray();\n                    var form = {};\n                    $.map(data, function (n, i) {\n                        form[n['name']] = n['value'];\n                    });\n\n                    $map.geoObjects.each(function (mark) {\n                        if (mark.properties.get('id') == form.id) {\n                            mark.properties.set('content', form.content);\n                            save_map();\n                        }\n                    });\n\n                    $map.balloon.close();\n\n                    return false;\n                });\n\n            });\n\n            $map.controls.add(export_button, {top: 5, right: 5});\n            $map.controls.add(import_button, {top: 5, right: 5});\n        }\n\n        /**\n         * Create geo mark\n         *\n         * @param {Array} coords\n         * @param {string} type Point type, Point or Circle\n         * @param {int} size Circle size in meters\n         * @param {int} id\n         * @param {string} content\n         */\n        function create_mark(coords, type, size, id, content) {\n\n            var place_mark = null;\n\n            var marker_type = (type != null) ? type.toLowerCase() : $($el).find('.marker-type').val();\n\n            var mark_id = id;\n            if (id == undefined && $params.marks.length == 0)\n                mark_id = 1;\n            else\n                mark_id = (id == undefined) ? ($params.marks[$params.marks.length - 1].id + 1) : id;\n\n            var mark_content = (content == undefined) ? '' : content;\n\n            if (marker_type == 'point') { // create placemark\n\n\n                $map.geoObjects.removeAll(); // remove all placemars\n\n                place_mark = new ymaps.Placemark(\n                    coords,\n                    {\n                        //iconContent: mark_id,\n                        hintContent: acf_yandex_locale.mark_hint\n                    }, {\n                        preset: \"islands#orangeDotIcon\",\n                        draggable: true\n                    }\n                );\n\n                place_mark.events.add('contextmenu', function () {\n                    $map.geoObjects.remove(this);\n                    save_map();\n                }, place_mark);\n\n                // place_mark.events.add('dragend', function () {\n                //     save_map();\n                // });\n                place_mark.properties.set('id', mark_id);\n                place_mark.properties.set('content', mark_content);\n\n                $map.geoObjects.add(place_mark);\n\n\n            } else { // if mark is circle (polygon)\n\n                $map.geoObjects.removeAll(); // remove all placemarks\n\n                var circle_size = (size != null) ? size : (parseInt($($el).find('.circle-size').val()) / 2);\n\n                place_mark = new ymaps.Circle([\n                    coords,\n                    circle_size\n                ], {\n                    hintContent: acf_yandex_locale.mark_hint\n                }, {\n                    draggable: true,\n                    opacity: 0.5,\n                    fillOpacity: 0.1,\n                    fillColor: \"#DB709377\",\n                    strokeColor: \"#990066\",\n                    strokeOpacity: 0.7,\n                    strokeWidth: 5\n                });\n\n                place_mark.events.add('contextmenu', function () {\n                    $map.geoObjects.remove(this);\n                    save_map();\n                }, place_mark);\n\n                place_mark.events.add('dragend', function () {\n                    save_map();\n                });\n                place_mark.properties.set('id', mark_id);\n                place_mark.properties.set('content', mark_content);\n\n                $map.geoObjects.add(place_mark);\n\n                // Если координаты всего две то сбросим их для рисования многоугольника с нуля \n                if ( coords.length === 2 ) {\n                    coords = [];\n                };\n\n                // Создаем многоугольник без вершин.\n                place_mark = new ymaps.Polygon(coords, {}, {\n                    draggable: true,\n                    // Курсор в режиме добавления новых вершин.\n                    editorDrawingCursor: \"crosshair\",\n                    // Максимально допустимое количество вершин.\n                    editorMaxPoints: 5,\n                    // Цвет заливки.\n                    fillColor: '#44A147',\n                    // Цвет обводки.\n                    strokeColor: '#18803F',\n                    // Ширина обводки.\n                    strokeWidth: 2\n                });\n\n                place_mark.properties.set('id', mark_id);\n                place_mark.properties.set('content', mark_content);\n\n                // Добавляем многоугольник на карту.\n                $map.geoObjects.add(place_mark);\n\n                // В режиме добавления новых вершин меняем цвет обводки многоугольника.\n                var stateMonitor = new ymaps.Monitor(place_mark.editor.state);\n                stateMonitor.add(\"drawing\", function (newValue) {\n                    place_mark.options.set(\"strokeColor\", newValue ? '#FF0000' : '#0000FF');\n                    console.log('test');\n                    if ( newValue === false ) {\n                        save_map(); // сохраняем карту при окончании редактирования\n                    };\n                });\n\n                // Включаем режим редактирования с возможностью добавления новых вершин.\n                place_mark.editor.startDrawing();\n\n            }\n\n            // Сохраним состояние карты после драга метки или полигона\n            place_mark.events.add('dragend', function () {\n                save_map();\n            });\n            \n\n            /// Выключили удаление метки правой кнопкой\n            // place_mark.events.add('contextmenu', function () {\n            //     $map.geoObjects.remove(this);\n            //     save_map();\n            // }, place_mark);\n            \n\n            /// Выключили балун\n            // place_mark.events.add('click', function () {\n            //     if (!this.balloon.isOpen()) {\n            //         show_mark_editor(this);\n            //     }\n            // }, place_mark);\n        }\n\n        /**\n         * Write map data in hidden field\n         */\n        function save_map() {\n\n            $params.zoom = $map.getZoom();\n\n            var coords = $map.getCenter();\n            $params.center_lat = coords[0];\n            $params.center_lng = coords[1];\n\n            var type = $map.getType().split('#');\n            $params.type = (type[1]) ? type[1] : 'map';\n\n            var marks = [];\n            $map.geoObjects.each(function (mark) {\n                var _type = mark.geometry.getType();\n                marks.push({\n                    id: mark.properties.get('id'),\n                    content: mark.properties.get('content'),\n                    type: _type,\n                    coords: mark.geometry.getCoordinates(),\n                    circle_size: (_type == 'Circle') ? mark.geometry.getRadius() : 0\n                });\n            });\n            $params.marks = marks;\n\n            $($input).val(JSON.stringify($params));\n        }\n\n        /**\n         * Import map from json\n         * @param data\n         * @returns {boolean}\n         */\n        function import_map(data) {\n\n            if (data.length == 0)\n                return false;\n\n            if (data[0].name != 'import')\n                return false;\n\n            try {\n                var imported = $.parseJSON(data[0].value);\n            }\n            catch (err) {\n                console.error(err, 'Import map error');\n                alert('Import map error');\n                return false;\n            }\n\n            $params = imported;\n\n            map_init();\n\n            return false;\n        }\n\n        /**\n         * Show mark editor\n         * @param mark\n         */\n        function show_mark_editor(mark) {\n            var html = '<div class=\"ya-editor\" style=\"margin: 5px\"><form name=\"mark\"><input type=\"hidden\" name=\"id\" value=\"' +\n                mark.properties.get('id') + '\"><textarea name=\"content\" rows=\"5\" cols=\"40\">' + mark.properties.get('content') +\n                '</textarea><input type=\"submit\" class=\"button button-primary\" value=\"' + acf_yandex_locale.mark_save +\n                '\"/>&nbsp;<button class=\"button remove\">' + acf_yandex_locale.mark_remove + '</button></form></div>';\n\n            $map.balloon.open(mark.geometry.getCoordinates(), html);\n\n            //console.info(mark.properties.get('id'));\n            //console.info(mark.properties.get('content'));\n\n\n            //$('input[name=\"color\"]').wpColorPicker({});\n        }\n\n        /**\n         * Change marker type state\n         */\n        $('.marker-type').on('change', function () {\n            var label = $(this).parent().next('th').children(0);\n            var select = $(this).parent().next('th').next('td').children(0);\n            if (this.value == 'circle') {\n                label.removeClass('hidden');\n                select.removeClass('hidden');\n            } else {\n                label.addClass('hidden');\n                select.addClass('hidden');\n            }\n        });\n\n    }\n\n\n    if (typeof acf.add_action !== 'undefined') {\n\n        /*\n         *  ready append (ACF5)\n         *\n         *  These are 2 events which are fired during the page load\n         *  ready = on page load similar to $(document).ready()\n         *  append = on new DOM elements appended via repeater field\n         *\n         *  @type\tevent\n         *  @date\t20/07/13\n         *\n         *  @param\t$el (jQuery selection) the jQuery element which contains the ACF fields\n         *  @return\tn/a\n         */\n\n        acf.add_action('ready append', function ($el) {\n\n            // search $el for fields of type 'FIELD_NAME'\n            acf.get_fields({type: 'yandex-map'}, $el).each(function () {\n\n                initialize_field($(this));\n\n            });\n\n        });\n\n\n    } else {\n\n\n        /*\n         *  acf/setup_fields (ACF4)\n         *\n         *  This event is triggered when ACF adds any new elements to the DOM.\n         *\n         *  @type\tfunction\n         *  @since\t1.0.0\n         *  @date\t01/01/12\n         *\n         *  @param\tevent\t\te: an event object. This can be ignored\n         *  @param\tElement\t\tpostbox: An element which contains the new HTML\n         *\n         *  @return\tn/a\n         */\n\n        $(document).on('acf/setup_fields', function (e, postbox) {\n\n            $(postbox).find('.field[data-field_type=\"yandex-map\"]').each(function () {\n\n                initialize_field($(this));\n\n            });\n\n        });\n\n\n    }\n\n\n})(jQuery);"]}