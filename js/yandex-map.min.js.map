{"version":3,"sources":["yandex-map.js"],"names":["$","plugin_url","yandex_locale","mark_style_house_orange","iconLayout","iconImageHref","iconImageSize","iconImageOffset","polygon_style_green","fillColor","strokeColor","strokeWidth","opacity","ymaps","ready","each","index","value","id","attr","undefined","window","$params","parseJSON","$map","Map","zoom","center","center_lat","center_lng","controls","remove","options","set","marks","mark","place_mark","type","Placemark","coords","balloonContent","content","Circle","circle_size","fillOpacity","strokeOpacity","geoObjects","add","$object_manager","ObjectManager","geoObjectOpenBalloonOnClick","object_style","Object","assign","load_balloon_data","object_id","post_id","deferred","vow","defer","get","url","ajax_url","data","action","nonce_code","nonce","done","console","log","baloon_data","object_json","object","offer_type","title","location","thumb_url","square","price","link","compile_baloon_data","resolve","fail","error","promise","objects","events","e","obj","getById","postId","properties","has_balloon_data","balloon","open","then","setData","on","removeAll","post","setBounds","getBounds","checkZoomRange","jQuery"],"mappings":"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","file":"yandex-map.min.js","sourcesContent":["(function ($) {\n\n    // 'use strict';\n\n    /**\n     * Plugin url\n     */\n    var plugin_url = yandex_locale.plugin_url;\n\n    /**\n     * Include common vars\n     */\n    // Common vars\n    \n    var mark_style_house_green = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-2.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var mark_style_house_orange = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-1.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var polygon_style_green = {\n        fillColor: '#44A147',\n        strokeColor: '#18803F',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n    \n    var polygon_style_orange = {\n        fillColor: 'rgba(0,0,0,0.00)',\n        strokeColor: '#EC6B23',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n\n    ymaps.ready(function () {\n\n        var $maps = $('.yandex-map');\n        $maps.each(function (index, value) {\n            var $mapElement = $(value),\n                id = $mapElement.attr('id');\n\n            if (id !== undefined && window[id] !== undefined) {\n\n                var $params = $.parseJSON(window[id]['params']);\n\n                var $map = new ymaps.Map(id, {\n                    zoom: $params.zoom,\n                    center: [$params.center_lat, $params.center_lng],\n                    // type: 'yandex#' + $params.type,\n                    // behaviors: ['dblClickZoom', 'multiTouch', 'drag']\n                }, {\n                    // minZoom: 10\n                });\n\n                $map.controls.remove('trafficControl');\n                $map.controls.remove('searchControl');\n                $map.controls.remove('geolocationControl');\n                $map.options.set('balloonMaxWidth', 290);\n\n                // Object map (need test)!\n                if ($params.marks != undefined) {\n                   \n                    $($params.marks).each(function (index, mark) {\n                        var place_mark = null;\n\n                        if (mark.type == 'Point') { // create placemark\n\n                            place_mark = new ymaps.Placemark(mark.coords, {\n                                balloonContent: mark.content\n                            });\n\n                        } else { // if mark is circle\n\n                            place_mark = new ymaps.Circle([\n                                mark.coords,\n                                mark.circle_size\n                            ], {\n                                balloonContent: mark.content\n                            }, {\n                                opacity: 0.5,\n                                fillOpacity: 0.1,\n                                fillColor: \"#DB709377\",\n                                strokeColor: \"#990066\",\n                                strokeOpacity: 0.7,\n                                strokeWidth: 5\n                            });\n\n                        }\n\n                        $map.geoObjects.add(place_mark);\n                    });\n\n                }\n\n                // Main map\n                if (id === 'ymap_full') {\n\n                    $object_manager = new ymaps.ObjectManager({\n                        // doesn't works with polygon\n                        // clusterize: true,\n                        // gridSize: 32\n\n                        // disable default baloon\n                        geoObjectOpenBalloonOnClick: false,\n                    });\n\n                    // set common style\n                    var object_style = Object.assign( {}, mark_style_house_orange, polygon_style_green );\n                    $object_manager.objects.options.set(object_style);\n\n                    function compile_baloon_data(object_json) {\n\n                        if (!object_json) return 'Ошибка!';\n\n                        var object = $.parseJSON(object_json);\n\n                        var baloon_data = \n                                '<div class=\"module--header\">' +\n                                    '<div class=\"module--title\">' +\n                                        '<div class=\"module--suptitle\">' + object.offer_type + '</div>' +\n                                        object.title +\n                                    '</div>' +\n                                '</div>' +\n                                '<div class=\"module--body\">' +\n                                    '<div class=\"module--item icb\">' +\n                                        '<i class=\"icb--icon icon icon-location\"></i>' +\n                                        '<div class=\"icb--title\">' + object.location + '</div>' +\n                                    '</div>' +\n                                    '<div class=\"module--item module--item-50\">' +\n                                        '<img src=\"' + object.thumb_url + '\" alt=\"Фото участка\" class=\"module--pic\">' +\n                                    '</div>' +\n                                    '<div class=\"module--item module--item-50\">' +\n                                        '<div class=\"common_item\">' +\n                                            '<div class=\"common_item--title\"><em>Площадь</em></div>' +\n                                            '<div class=\"common_item--value\">' + object.square + '</div>' +\n                                        '</div>' +\n                                        '<div class=\"common_item\">' +\n                                            '<div class=\"common_item--title\"><em>Стоимость</em></div>' +\n                                            '<div class=\"common_item--value\">' + object.price + ' ₽</div>' +\n                                        '</div>' +\n                                    '</div>' +\n                                '</div>' +\n                                '<div class=\"module--footer module--footer-center\">' +\n                                    '<a href=\"' + object.link + '\" class=\"module--but but but-green\">Подробнее</a>' +\n                                '</div>';\n                        \n                        return baloon_data;\n                    }\n\n\n                    function load_balloon_data(object_id, post_id) {\n\n                        var deferred = ymaps.vow.defer();\n\n                        $.get({\n                            url: yandex_locale.ajax_url,\n                            data: {\n                                action: 'ymap_object_load',\n                                nonce_code: yandex_locale.nonce,\n                                post_id: post_id,\n                            }\n                        })\n                        .done(function(data) {\n                            console.log(\"Object data loaded\");\n                            var baloon_data = compile_baloon_data(data);\n                            deferred.resolve(baloon_data);\n                        })\n                        .fail(function() {\n                            console.error('Object data error');\n                            deferred.resolve('Ошибка!');\n                        });\n                            \n                        return deferred.promise();\n                    }\n\n                    function has_balloon_data(object_id) {\n                        return $object_manager.objects.getById(object_id).properties.balloonContent;\n                    }\n\n                    $object_manager.objects.events.add('click', function (e) {\n                        var object_id = e.get('objectId'),\n                            obj = $object_manager.objects.getById(object_id),\n                            postId = obj.id;\n                        if (has_balloon_data(object_id)) {\n                            $object_manager.objects.balloon.open(object_id);\n                        } else {\n                            obj.properties.balloonContent = \"Идет загрузка данных...\";\n                            $object_manager.objects.balloon.open(object_id);\n\n                            load_balloon_data(object_id, postId).then(function (data) {\n                                obj.properties.balloonContent = data;\n                                $object_manager.objects.balloon.setData(obj);\n                            });\n\n                        }\n                    });\n                    \n                    // load objects\n                    function load_objects(data_type) {\n\n                        $map.geoObjects.add($object_manager);\n\n                        $.post({\n                            url: yandex_locale.ajax_url,\n                            data: {\n                                action: 'ymaps_json_post',\n                                nonce_code: yandex_locale.nonce,\n                                data: 'test'\n                            }\n                        })\n                        .done(function(data) {\n                            $object_manager.add(data);\n                            console.log('Map data loaded');\n                            $map.setBounds($map.geoObjects.getBounds(), {\n                                checkZoomRange: true\n                            });\n                        })\n                        .fail(function() {\n                            console.error(\"Map data error\");\n                        });\n                    }\n\n                    $('.js-map-link').on('click', function() {\n\n                        $object_manager.removeAll()\n\n                        // var jsons = [\n                        //     'land-vsevolozhsk',\n                        //     'land-tajtsy'\n                        // ];\n\n                        load_objects();\n                    });\n\n                }\n\n            }\n        });\n\n    });\n\n})(jQuery);"]}