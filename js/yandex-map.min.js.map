{"version":3,"sources":["yandex-map.js"],"names":["$","plugin_url","yandex_locale","mark_style_house_green","iconLayout","iconImageHref","iconImageSize","iconImageOffset","mark_style_house_yellow","mark_style_house_red","polygon_style_green","fillColor","strokeColor","strokeWidth","opacity","polygon_style_yellow","polygon_style_red","ymaps","ready","each","index","value","id","attr","undefined","window","$params","parseJSON","$map","Map","zoom","center","center_lat","center_lng","controls","remove","options","set","marks","mark","place_mark","type","Placemark","coords","Polygon","geoObjects","add","load_objects","filter","post","url","ajax_url","data","action","nonce_code","nonce","done","response","console","log","features","length","objects","val","status","slug","object","geometry","coordinates","push","$object_manager","setBounds","getBounds","checkZoomRange","error","toggle_map","toggleClass","toggle","container","fitToViewport","ObjectManager","geoObjectOpenBalloonOnClick","events","e","object_id","get","obj","getById","postId","properties","balloonContent","has_balloon_data","balloon","open","post_id","deferred","vow","defer","baloon_data","object_json","offer_type","status_slug","status_name","title","location","thumb_url","square","price","edit_link","link","compile_baloon_data","resolve","fail","promise","load_balloon_data","then","setData","removeAll","removeAttr","on","form","this","parents","serializeArray","name","jQuery"],"mappings":"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","file":"yandex-map.min.js","sourcesContent":["(function ($) {\n\n    /**\n     * Plugin url\n     */\n    var plugin_url = yandex_locale.plugin_url;\n\n    /**\n     * Include common vars\n     */\n    // Common vars\n    \n    var mark_style_house_green = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-green.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var mark_style_house_orange = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-orange.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var mark_style_house_yellow = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-yellow.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var mark_style_house_red = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-red.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var mark_style_house_gray = {\n        iconLayout: 'default#image',\n        iconImageHref: plugin_url + 'svg/mark-house-gray.svg',\n        iconImageSize: [36, 36],\n        iconImageOffset: [-18, -36]\n    };\n    \n    var polygon_style_green = {\n        fillColor: '#44A147',\n        strokeColor: '#18803F',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n    \n    var polygon_style_orange = {\n        // fillColor: 'rgba(0,0,0,0.00)',\n        fillColor: '#E3D5B1',\n        strokeColor: '#EC6B23',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n    \n    var polygon_style_yellow = {\n        fillColor: '#FFEE8B',\n        strokeColor: '#FFDE17',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n    \n    var polygon_style_red = {\n        fillColor: '#F7A09A',\n        strokeColor: '#ED1C25',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n    \n    var polygon_style_gray = {\n        fillColor: '#A3ACB2',\n        strokeColor: '#88959E',\n        strokeWidth: 2,\n        opacity: 0.7\n    };\n\n    ymaps.ready(function () {\n\n        var $maps = $('.yandex-map');\n\n        $maps.each(function (index, value) {\n            var $mapElement = $(value),\n                id = $mapElement.attr('id');\n\n            if (id !== undefined && window[id] !== undefined) {\n\n                var $params = $.parseJSON(window[id]['params']);\n\n                var $map = new ymaps.Map(id, {\n                    zoom: $params.zoom,\n                    center: [$params.center_lat, $params.center_lng],\n                    // type: 'yandex#' + $params.type,\n                    // behaviors: ['dblClickZoom', 'multiTouch', 'drag']\n                }, {\n                    // minZoom: 10\n                });\n\n                $map.controls.remove('trafficControl');\n                $map.controls.remove('searchControl');\n                $map.controls.remove('geolocationControl');\n                $map.options.set('balloonMaxWidth', 290);\n\n                // Object map\n                if ($params.marks != undefined) {\n                    $($params.marks).each(function (index, mark) {\n                        var place_mark = null;\n                        if (mark.type == 'Point') { // create placemark\n                            place_mark = new ymaps.Placemark(\n                                mark.coords,\n                                {},\n                                mark_style_house_green\n                            );\n                        } else if (mark.type == 'Polygon') { // if mark is polygon\n                            place_mark = new ymaps.Polygon(\n                                mark.coords, \n                                {}, \n                                polygon_style_green \n                            );\n                        }\n                        $map.geoObjects.add(place_mark);\n                    });\n                };\n\n                // Main map\n                if (id === 'ymap_full' || id === 'ymap_project' ) {\n\n                    // object manager instance\n                    $object_manager = new ymaps.ObjectManager({\n                        // doesn't works with polygon\n                        // clusterize: true,\n                        // gridSize: 32,\n\n                        // disable default baloon\n                        geoObjectOpenBalloonOnClick: false,\n                    });\n\n                    // object manager event\n                    $object_manager.objects.events.add('click', function (e) {\n                        var object_id = e.get('objectId'),\n                            obj = $object_manager.objects.getById(object_id),\n                            postId = obj.id;\n                        if (has_balloon_data(object_id)) {\n                            $object_manager.objects.balloon.open(object_id);\n                        } else {\n                            obj.properties.balloonContent = \"Идет загрузка данных...\";\n                            $object_manager.objects.balloon.open(object_id);\n\n                            load_balloon_data(object_id, postId).then(function (data) {\n                                obj.properties.balloonContent = data;\n                                $object_manager.objects.balloon.setData(obj);\n                            });\n\n                        }\n                    });\n                    \n                    // load objects method\n                    function load_objects(filter) {\n\n                        if ( !filter ) filter = 'all'; // load all objects\n\n                        $.post({\n                            url: yandex_locale.ajax_url,\n                            data: {\n                                action: 'ymaps_json_post',\n                                nonce_code: yandex_locale.nonce,\n                                data: filter\n                            }\n                        })\n                        .done(function(response) {\n\n                            console.log(response);\n\n                            var data = $.parseJSON(response);\n\n                            if ( data.features.length > 0 ) {\n\n                                var objects = [];\n\n                                $.each(data.features, function(index, val) {\n\n                                    var status = (val.status) ? val.status.slug : false;\n                                    var object = {};\n\n                                    if (val.geometry.type === 'Point') {\n\n                                        var object = {\n                                            type: 'Feature',\n                                            id: val.id,\n                                            geometry: {\n                                                type: 'Point',\n                                                coordinates: val.geometry.coordinates\n                                            }\n                                        }\n                                        switch(status) {\n                                            case 'vacant':\n                                                object.options = mark_style_house_green;\n                                                break;\n                                            case 'reserved':\n                                                object.options = mark_style_house_yellow;\n                                                break;\n                                            case 'booked':\n                                                object.options = mark_style_house_red;\n                                                break;\n                                            default :\n                                                object.options = mark_style_house_green;\n                                                break;\n                                        }\n                                    } else if (val.geometry.type === 'Polygon') {\n\n                                        var object = {\n                                            type: 'Feature',\n                                            id: val.id,\n                                            geometry: {\n                                                type: 'Polygon',\n                                                coordinates: val.geometry.coordinates\n                                            }\n                                        }\n                                        switch(status) {\n                                            case 'vacant':\n                                                object.options = polygon_style_green;\n                                                break;\n                                            case 'reserved':\n                                                object.options = polygon_style_yellow;\n                                                break;\n                                            case 'booked':\n                                                object.options = polygon_style_red;\n                                                break;\n                                            default :\n                                                object.options = polygon_style_green;\n                                                break;\n                                        }\n                                    }\n                                    objects.push(object);\n                                });\n\n                                $object_manager.add(objects);\n                                $map.geoObjects.add($object_manager);\n                                console.log('Map data loaded');\n                                $map.setBounds($map.geoObjects.getBounds(), {\n                                    checkZoomRange: true\n                                });\n\n\n\n                            } else {\n\n                                console.error(\"Map data error\");\n                            };\n                        });\n                    }\n\n                    // toggle map method\n                    function toggle_map() {\n                        $('.js-wrapper').toggleClass('wrapper-map_show');\n                        $('.js-supheader').toggleClass('supheader-hidden');\n                        $('.js-header').toggleClass('header-map_show');\n                        $('.js-content').toggleClass('content-hidden');\n                        $('.js-footer').toggleClass('footer-hidden');\n\n                        $('.js-big-map').toggle();\n                        $('.yandex-map').toggle();\n\n                        $map.container.fitToViewport();\n                    };\n\n                    // project objects action\n                    var filter = yandex_locale.filter;\n                    console.log(filter);\n                    if (filter) {\n                        $object_manager.removeAll()\n                        load_objects(filter);\n                    };\n\n                    // maybe usefull\n                    // myMap.container.fitToViewport();\n                    // $('.js-map-link').on('click', function () {    \n                    //     toggleMapClasses();\n                    // });\n\n                    // $('.js-map-close').on('click', function() {\n                    //     toggleMapClasses();\n                    // });\n\n                    // filter active\n                    $('.js-filter-map').removeAttr('disabled');\n\n                    // filter objects action\n                    $('.js-filter-map').on('click', function() {\n                        var filter = {};\n                        // get form params\n                        var form = $(this).parents('.js-filter-form').serializeArray();\n                        $(form).each(function(index, val){\n                            filter[val.name] = val.value;\n                        });\n                        // apply\n                        console.log(filter);\n                        $object_manager.removeAll();\n                        load_objects(filter);\n                        toggle_map();\n                    });\n\n                    // default objects action\n                    $('.js-map-link').on('click', function() {\n                        $object_manager.removeAll();\n                        toggle_map();\n                        load_objects();\n                    });\n\n                    // default close action\n                    $('.js-map-close').on('click', function() {\n                        $object_manager.removeAll();\n                        toggle_map();\n                    });\n\n                    // ballon methods\n                    function compile_baloon_data(object_json) {\n\n                        if (!object_json) return 'Ошибка!';\n\n                        var object = $.parseJSON(object_json);\n\n                        var baloon_data = \n                            '<div class=\"module--header\">' +\n                                '<div class=\"module--title\">' +\n                                    '<div class=\"module--offer\">' + \n                                        '<div class=\"module--suptitle\">' + object.offer_type + '</div>' +\n                                        '<div class=\"module--status status status-' + object.status_slug + '\">' + \n                                            object.status_name + \n                                        '</div>' +\n                                    '</div>' + \n                                    object.title +\n                                '</div>' +\n                            '</div>' +\n                            '<div class=\"module--body\">' +\n                                '<div class=\"module--item icb\">' +\n                                    '<i class=\"icb--icon icon icon-location\"></i>' +\n                                    '<div class=\"icb--title\">' + object.location + '</div>' +\n                                '</div>' +\n                                '<div class=\"module--item module--item-50\">' +\n                                    '<img src=\"' + object.thumb_url + '\" alt=\"Фото участка\" class=\"module--pic\">' +\n                                '</div>' +\n                                '<div class=\"module--item module--item-50\">' +\n                                    '<div class=\"common_item\">' +\n                                        '<div class=\"common_item--title\"><em>Площадь</em></div>' +\n                                        '<div class=\"common_item--value\">' + object.square + '</div>' +\n                                    '</div>' +\n                                    '<div class=\"common_item\">' +\n                                        '<div class=\"common_item--title\"><em>Стоимость</em></div>' +\n                                        '<div class=\"common_item--value\">' + object.price + ' ₽</div>' +\n                                    '</div>' +\n                                '</div>' +\n                            '</div>';\n\n                        if (object.edit_link) {\n                            baloon_data += '<div class=\"module--footer\">' +\n                                '<a href=\"' + object.edit_link + '\" class=\"module--more\">Редактировать участок</a>' + \n                                '<a href=\"' + object.link + '\" class=\"module--but but but-green\">Подробнее</a>' +\n                            '</div>'\n                        } else {\n                            baloon_data += '<div class=\"module--footer module--footer-center\">' +\n                                '<a href=\"' + object.link + '\" class=\"module--but but but-green\">Подробнее</a>' +\n                            '</div>';\n                        }\n                        \n                        return baloon_data;\n                    }\n\n                    function load_balloon_data(object_id, post_id) {\n\n                        var deferred = ymaps.vow.defer();\n\n                        $.get({\n                            url: yandex_locale.ajax_url,\n                            data: {\n                                action: 'ymap_object_load',\n                                nonce_code: yandex_locale.nonce,\n                                post_id: post_id,\n                            }\n                        })\n                        .done(function(data) {\n                            console.log(\"Object data loaded\");\n                            var baloon_data = compile_baloon_data(data);\n                            deferred.resolve(baloon_data);\n                        })\n                        .fail(function() {\n                            console.error('Object data error');\n                            deferred.resolve('Ошибка!');\n                        });\n                            \n                        return deferred.promise();\n                    }\n\n                    function has_balloon_data(object_id) {\n                        return $object_manager.objects.getById(object_id).properties.balloonContent;\n                    }\n                }\n            }\n        });\n    });\n})(jQuery);"]}